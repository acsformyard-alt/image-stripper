<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upper-Right Text Remover — LaMa (Local model, Cloudflare Pages)</title>
  <link rel="stylesheet" href="/styles.css" />

  <script src="/lib/ort.wasm.min.js"></script>
<script>
  if (globalThis.ort?.env?.wasm) {
    ort.env.wasm.wasmPaths = "/lib/";    // REQUIRED so ORT finds its binaries
    // Threads will only work after Section C (cross-origin isolation)
    ort.env.wasm.numThreads = Math.max(2, (navigator.hardwareConcurrency||8) >> 1);
  }
</script>

</head>
<body>
  <header>
    <h1>Upper-Right Text Remover (Local LaMa model)</h1>
    <p class="muted">
      Deployed on Cloudflare Pages. Select a <code>.onnx</code> model from your computer (not uploaded), then pick images.
      Nothing leaves your device. Defaults to WASM for stability; you can switch to WebGPU later.
    </p>
  </header>

  <main>
    <section class="controls">
      <input id="prompt" class="prompt" value="Remove the text and numbers from the upper right of the image" />

      <label class="btn">
        <input id="modelInput" type="file" accept=".onnx" />
        Choose LaMa model (.onnx)
      </label>

      <label class="btn">
        <input id="fileInput" type="file" accept="image/*" multiple />
        Choose images
      </label>

      <button id="processBtn" class="primary" disabled>Process</button>
      <span id="status" class="status">Pick model, then images.</span>

      <span class="pill" id="modelName">No model selected</span>
      <span class="pill" id="imagesInfo">No images</span>
    </section>

    <section>
      <div id="gallery" class="gallery"></div>
    </section>
  </main>

  <div id="globalSpinner" class="spinner" aria-hidden="true"></div>

  <pre id="log" class="log"></pre>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script type="module">
    import { initLamaFromBuffer, setExecutionProviders, inpaintUpperRightOne, setLogger, setAssumeBGR, maskUpperRightViaOCR } from '/js/lama.js';
    import { uiInit, setModelLabel, setBusy, wireImagePicker } from '/js/app.js';

    const statusEl   = document.getElementById('status');
    const modelInput = document.getElementById('modelInput');
    const modelName  = document.getElementById('modelName');
    const processBtn = document.getElementById('processBtn');
    const logEl      = document.getElementById('log');

    const log = (m) => { logEl.textContent += m + "\n"; };
    setLogger(log);

    // STABILITY FIRST: force WASM for now (you can change to ['webgpu','wasm'] later)
    setExecutionProviders(['wasm']);
    if (globalThis.ort?.env?.wasm) {
      // modest threading; adjust if you want more
      ort.env.wasm.numThreads = Math.max(2, (navigator.hardwareConcurrency || 8) >> 1);
    }

    uiInit({ inpaintOne: inpaintUpperRightOne, statusEl, maskBuilder: maskUpperRightViaOCR });
    wireImagePicker();

    const filesInput = document.getElementById('fileInput');
    const syncProcessEnabled = () => {
      const hasModel  = modelName.textContent !== 'No model selected';
      const hasImages = filesInput.files && filesInput.files.length > 0;
      processBtn.disabled = !(hasModel && hasImages);
    };
    filesInput.addEventListener('change', syncProcessEnabled);

    modelInput.addEventListener('change', async () => {
      const f = modelInput.files?.[0];
      if (!f) return;
      setModelLabel(f.name);
      syncProcessEnabled();
      try {
        setBusy(true, 'Reading model…');
        const buf = await f.arrayBuffer();
        setBusy(true, 'Initializing LaMa…');
        await initLamaFromBuffer(new Uint8Array(buf));
        statusEl.textContent = 'Model ready. Choose images.';
        log('Model initialized: ' + f.name);
      } catch (e) {
        console.error(e);
        log('Model init error: ' + (e.message || e));
        statusEl.textContent = 'Failed to initialize model.';
      } finally {
        setBusy(false);
        syncProcessEnabled();
      }
    });

    if (typeof ort === 'undefined') {
      statusEl.textContent = 'onnxruntime-web not loaded. (Check CDN or /lib/ path.)';
      log('ERROR: ort is undefined (script failed to load).');
    } else {
      log('onnxruntime-web loaded. WebGPU available: ' + ('gpu' in navigator));
    }

    // If after trying these fixes you still get white, toggle BGR here:
    // setAssumeBGR(true);
  </script>
</body>
</html>


